{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<section class="stripe-section" style="padding-top: 3rem; padding-bottom: 3rem;">
  <div class="container" style="max-width: 1200px;">
    <div class="mb-4 animate-fade-in-up">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <a href="{% url 'tickets:operator_ticket_list' %}" class="stripe-nav-link" style="display: inline-flex; align-items: center; margin-bottom: 0.5rem;">
            <i class="bi bi-arrow-left me-1"></i>{% if request.user.language == 'kk' %}Артқа{% else %}Назад{% endif %}
          </a>
          <h1 style="font-size: 2rem; font-weight: 700; margin: 0; letter-spacing: -0.02em;">
            {% if request.user.language == 'kk' %}Чат: #{{ ticket.id }}{% else %}Чат: #{{ ticket.id }}{% endif %}
          </h1>
          <p style="color: var(--kt-text-light); margin: 0.5rem 0 0 0;">
            {% if request.user.language == 'kk' %}
              Клиент: {{ ticket.author.full_name|default:ticket.author.username }}
            {% else %}
              Клиент: {{ ticket.author.full_name|default:ticket.author.username }}
            {% endif %}
          </p>
        </div>
        <div>
          {% if ticket.operator_joined %}
            <span class="badge bg-success" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
              <i class="bi bi-check-circle me-1"></i>{% if request.user.language == 'kk' %}Чатта{% else %}В чате{% endif %}
            </span>
          {% else %}
            <span class="badge bg-warning text-dark" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
              <i class="bi bi-exclamation-triangle me-1"></i>{% if request.user.language == 'kk' %}Жаңа эскалация{% else %}Новая эскалация{% endif %}
            </span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Информация о тикете -->
      <div class="col-lg-4 mb-4">
        <div class="stripe-card animate-fade-in-up">
          <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">
            {% if request.user.language == 'kk' %}Ақпарат{% else %}Информация{% endif %}
          </h3>
          
          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Тақырып{% else %}Тема{% endif %}
            </div>
            <div style="font-weight: 600;">{{ ticket.subject }}</div>
          </div>

          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Санат{% else %}Категория{% endif %}
            </div>
            <div>
              <span class="badge" style="background-color: var(--kt-surface); color: var(--kt-text); padding: 0.375rem 0.75rem;">
                {{ ticket.get_category_display }}
              </span>
            </div>
          </div>

          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Басымдық{% else %}Приоритет{% endif %}
            </div>
            <div>
              <span class="badge {% if ticket.priority == 'high' %}bg-danger{% elif ticket.priority == 'medium' %}bg-warning text-dark{% else %}bg-success{% endif %}" style="padding: 0.375rem 0.75rem;">
                {{ ticket.get_priority_display }}
              </span>
            </div>
          </div>

          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Бөлім{% else %}Отдел{% endif %}
            </div>
            <div style="font-weight: 600;">{{ ticket.get_department_display }}</div>
          </div>

          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Жасалған{% else %}Создан{% endif %}
            </div>
            <div>{{ ticket.created_at|date:"d.m.Y H:i" }}</div>
          </div>

          {% if ticket.escalated_at %}
          <div class="mb-3">
            <div style="font-size: 0.875rem; color: var(--kt-text-light); margin-bottom: 0.25rem;">
              {% if request.user.language == 'kk' %}Эскалация уақыты{% else %}Время эскалации{% endif %}
            </div>
            <div>{{ ticket.escalated_at|date:"d.m.Y H:i" }}</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Чат -->
      <div class="col-lg-8">
        <div class="stripe-card animate-fade-in-up" style="animation-delay: 0.1s;">
          <div id="chat-messages" style="height: 500px; overflow-y: auto; margin-bottom: 1.5rem; padding: 1rem; background: var(--kt-surface); border-radius: 12px;">
            {% for msg in messages %}
              <div class="mb-3" style="display: flex; {% if msg.sender and msg.sender != ticket.author %}justify-content: flex-end;{% else %}justify-content: flex-start;{% endif %}">
                <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 12px; {% if msg.is_bot %}background: linear-gradient(135deg, #00AEEF 0%, #0099d6 100%); color: #fff;{% elif msg.sender and msg.sender != ticket.author %}background: var(--kt-primary); color: #fff;{% else %}background: #fff; border: 1px solid var(--kt-border);{% endif %}">
                  <div style="font-size: 0.75rem; margin-bottom: 0.25rem; opacity: 0.8;">
                    {% if msg.is_bot %}
                      AI
                    {% elif msg.sender %}
                      {{ msg.sender.username }}
                    {% else %}
                      {{ ticket.author.username }}
                    {% endif %}
                  </div>
                  <div>{{ msg.text }}</div>
                  {% if msg.image %}
                    <img src="{{ msg.image.url }}" alt="Attachment" style="max-width: 100%; margin-top: 0.5rem; border-radius: 8px;">
                  {% endif %}
                  <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">
                    {{ msg.created_at|date:"H:i" }}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Форма отправки сообщения -->
          <form id="operator-message-form" style="display: flex; gap: 0.75rem;">
            {% csrf_token %}
            <input type="text" id="operator-message-input" placeholder="{% if request.user.language == 'kk' %}Хабарламаңызды жазыңыз...{% else %}Напишите сообщение...{% endif %}" style="flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--kt-border); border-radius: 12px; font-size: 1rem;">
            <button type="submit" class="stripe-btn-primary" style="padding: 0.75rem 1.5rem;">
              <i class="bi bi-send me-1"></i>{% if request.user.language == 'kk' %}Жіберу{% else %}Отправить{% endif %}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const ticketId = {{ ticket.id }};
  const chatMessages = document.getElementById('chat-messages');
  const messageForm = document.getElementById('operator-message-form');
  const messageInput = document.getElementById('operator-message-input');

  // Автоматически присоединяемся к чату при загрузке страницы
  {% if not ticket.operator_joined %}
  fetch(`/tickets/api/operator/chat/${ticketId}/join/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    }
  });
  {% endif %}

  // Отправка сообщения
  messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const text = messageInput.value.trim();
    if (!text) return;

    const formData = new FormData();
    formData.append('text', text);

    try {
      const response = await fetch(`/tickets/api/operator/chat/${ticketId}/send/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
      });

      if (response.ok) {
        messageInput.value = '';
        loadMessages();
      }
    } catch (error) {
      console.error('Ошибка отправки сообщения:', error);
    }
  });

  // Загрузка сообщений
  async function loadMessages() {
    try {
      const response = await fetch(`/tickets/api/operator/chat/${ticketId}/messages/`);
      const data = await response.json();
      
      // Обновляем список сообщений
      chatMessages.innerHTML = '';
      data.messages.forEach(msg => {
        const isOperator = msg.sender && msg.sender !== '{{ ticket.author.username }}';
        const isBot = msg.is_bot;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-3';
        messageDiv.style.display = 'flex';
        messageDiv.style.justifyContent = isOperator ? 'flex-end' : 'flex-start';
        
        let bgStyle = '';
        if (isBot) {
          bgStyle = 'background: linear-gradient(135deg, #00AEEF 0%, #0099d6 100%); color: #fff;';
        } else if (isOperator) {
          bgStyle = 'background: var(--kt-primary); color: #fff;';
        } else {
          bgStyle = 'background: #fff; border: 1px solid var(--kt-border);';
        }
        
        messageDiv.innerHTML = `
          <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 12px; ${bgStyle}">
            <div style="font-size: 0.75rem; margin-bottom: 0.25rem; opacity: 0.8;">
              ${isBot ? 'AI' : msg.sender}
            </div>
            <div>${msg.text}</div>
            <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">
              ${new Date(msg.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
            </div>
          </div>
        `;
        
        chatMessages.appendChild(messageDiv);
      });
      
      // Прокручиваем вниз
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
      console.error('Ошибка загрузки сообщений:', error);
    }
  }

  // Обновляем сообщения каждые 3 секунды
  setInterval(loadMessages, 3000);
</script>
{% endblock %}
